---
import "@chamfer/core/css";
import "@styles/global.css";
import Logo from "@components/layout/Logo.astro";
import Footer from "@components/layout/Footer.astro";
import Hamburger from "@components/icons/Hamburger.astro";
import Close from "@components/icons/Close.astro";
import initButtonsScript from "../scripts/init-buttons.js?url";

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
const basePath = Astro.site ? Astro.site.pathname.replace(/\/$/, "") : "";
const currentPath = Astro.url.pathname.replace(/\/+$/, "") || "/";
const relativePath =
  basePath && currentPath.startsWith(basePath)
    ? currentPath.slice(basePath.length) || "/"
    : currentPath;

const withBase = (path) => {
  if (!path) return path;
  if (/^[a-zA-Z]+:/.test(path) || path.startsWith("#")) {
    return path;
  }
  if (path.startsWith("/@")) {
    return path;
  }
  if (basePath && path.startsWith(`${basePath}/`)) {
    return path;
  }
  if (path === "/") {
    return basePath || "/";
  }
  if (!path.startsWith("/")) {
    return `${basePath}/${path}`;
  }
  return `${basePath}${path}`;
};

const initButtonsSrc =
  import.meta.env?.DEV === true ? initButtonsScript : withBase(initButtonsScript);

const navGroups = [
  {
    title: "Getting Started",
    links: [
      { href: "/", label: "Overview" },
      { href: "/foundations/quick-start", label: "Quick Start" }
    ]
  },
  {
    title: "Foundations",
    links: [
      { href: "/foundations/design-principles", label: "Design Principles" },
      { href: "/foundations/typography", label: "Typography" },
      { href: "/foundations/tokens", label: "Tokens & Theming" },
      { href: "/foundations/accessibility", label: "Accessibility" },
      { href: "/foundations/tooling", label: "Tooling & Workflow" }
    ]
  },
  {
    title: "Components",
    links: [{ href: "/components/button", label: "Button" }]
  },
  {
    title: "Guides",
    links: [{ href: "#", label: "Theming Recipes", disabled: true }]
  },
  {
    title: "Reference",
    links: [
      { href: "/reference/roadmap", label: "Roadmap" },
      { href: "/reference/changelog", label: "Changelog" }
    ]
  }
];
---

<!doctype html>
<html lang="en" data-theme="system">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} Â· Chamfer UI</title>
    {description && <meta name="description" content={description} />}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900"
    />
    <link rel="icon" type="image/svg+xml" href={withBase("/favicon.svg")} />
    <slot name="head" />
  </head>
  <body class="docs-root">
    <header class="mobile-header">
      <button
        id="mobile-nav-toggle"
        class="mobile-nav-toggle"
        type="button"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <Hamburger size={24} color="currentColor" />
        <span class="sr-only">Toggle navigation</span>
      </button>
      <a href={withBase("/")} class="mobile-brand">
        <Logo size={24} />
        <span>Chamfer UI</span>
      </a>
    </header>

    <div class="docs-shell">
      <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
      <aside class="docs-sidebar" id="docs-sidebar" data-open="false">
        <button
          id="mobile-nav-close"
          class="sidebar-close"
          type="button"
          aria-label="Close navigation"
        >
          <Close size={22} color="currentColor" />
          <span class="sr-only">Close navigation</span>
        </button>
        <div class="brand">
          <a href={withBase("/")} class="brand__link">
            <Logo size={32} />
            <div class="brand__text">
              <span class="brand__title">Chamfer UI</span>
              <p class="brand__subtitle">Framework-agnostic component system</p>
            </div>
          </a>
        </div>

        <nav aria-label="Primary" class="nav-sections">
          {navGroups.map(group => (
            <div class="nav-section">
              <p class="nav-section__title">{group.title}</p>
              <div class="nav-list">
                {group.links.map(link => {
                  const normalized = link.href === "/" ? "/" : link.href.replace(/\/+$/, "");
                  const isCurrent = normalized === relativePath;
                  return (
                    <a
                      href={link.disabled ? "#" : withBase(link.href)}
                      class={`nav-link${link.disabled ? " nav-link--disabled" : ""}`}
                      aria-current={isCurrent ? "page" : undefined}
                      aria-disabled={link.disabled ? "true" : undefined}
                      tabindex={link.disabled ? -1 : undefined}
                    >
                      {link.label}
                    </a>
                  );
                })}
              </div>
            </div>
          ))}
        </nav>

        <div class="sidebar-controls">
          <label class="control-label" for="theme-select">Theme</label>
          <select id="theme-select" aria-label="Theme">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="system" selected>System</option>
          </select>
          <button id="hcm-toggle" class="control-button" type="button" aria-pressed="false">
            High contrast off
          </button>
        </div>

        <footer class="sidebar-footer">
          <a href="https://github.com/chamfer-ui" target="_blank" rel="noreferrer">
            GitHub
          </a>
          <a href="https://www.npmjs.com/org/chamfer" target="_blank" rel="noreferrer">
            npm
          </a>
        </footer>
      </aside>

      <main class="docs-main">
        <slot />
      </main>
    </div>

    <Footer basePath={basePath} />

    <script is:inline>
      const root = document.documentElement;
      const themeSelect = document.getElementById("theme-select");
      const hcmToggle = document.getElementById("hcm-toggle");
      const sidebar = document.getElementById("docs-sidebar");
      const mobileToggle = document.getElementById("mobile-nav-toggle");
      const mobileClose = document.getElementById("mobile-nav-close");
      const sidebarBackdrop = document.getElementById("sidebar-backdrop");
      const prefersDark =
        typeof window !== "undefined" && "matchMedia" in window
          ? window.matchMedia("(prefers-color-scheme: dark)")
          : null;

      function resolveTheme(value) {
        if (value === "system" && prefersDark) {
          return prefersDark.matches ? "dark" : "light";
        }
        return value;
      }

      function updateTheme(value) {
        const resolved = resolveTheme(value);
        root.setAttribute("data-theme", value);
        root.classList.toggle("dark", resolved === "dark");
        root.style.setProperty("color-scheme", resolved);
      }

      function updateContrast(state) {
        root.classList.toggle("hcm", state);
        if (hcmToggle instanceof HTMLButtonElement) {
          hcmToggle.setAttribute("aria-pressed", String(state));
          hcmToggle.textContent = state ? "High contrast on" : "High contrast off";
        }
      }

      if (themeSelect instanceof HTMLSelectElement) {
        themeSelect.addEventListener("change", event => {
          const value = event.target.value;
          updateTheme(value);
        });
        if (prefersDark) {
          const listener = () => {
            if (themeSelect.value === "system") {
              updateTheme("system");
            }
          };
          if (typeof prefersDark.addEventListener === "function") {
            prefersDark.addEventListener("change", listener);
          } else if (typeof prefersDark.addListener === "function") {
            prefersDark.addListener(listener);
          }
        }
        updateTheme(themeSelect.value);
      }

      if (hcmToggle instanceof HTMLButtonElement) {
        hcmToggle.addEventListener("click", () => {
          const next = !root.classList.contains("hcm");
          updateContrast(next);
        });
        updateContrast(false);
      }

      function setSidebar(state) {
        if (!sidebar || !(mobileToggle instanceof HTMLButtonElement)) {
          return;
        }
        sidebar.dataset.open = String(state);
        mobileToggle.setAttribute("aria-expanded", String(state));
        document.body.classList.toggle("drawer-open", state);
      }

      if (mobileToggle instanceof HTMLButtonElement) {
        mobileToggle.addEventListener("click", () => {
          const nextState = sidebar?.dataset.open !== "true";
          setSidebar(nextState);
        });
      }

      if (mobileClose instanceof HTMLButtonElement) {
        mobileClose.addEventListener("click", () => setSidebar(false));
      }

      if (sidebarBackdrop) {
        sidebarBackdrop.addEventListener("click", () => setSidebar(false));
      }

      document.querySelectorAll(".docs-sidebar .nav-link").forEach(link => {
        link.addEventListener("click", event => {
          if (link.getAttribute("aria-disabled") === "true") {
            event.preventDefault();
            return;
          }
          if (window.innerWidth <= 960) {
            setSidebar(false);
          }
        });
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth > 960) {
          setSidebar(false);
        }
      });
    </script>

    <style lang="css">
      .brand {
        display: flex;
        flex-direction: column;
      }

      .brand__link {
        display: flex;
        align-items: center;
        gap: var(--ch-space-md);
        text-decoration: none;
        transition: opacity var(--ch-dur-fast) var(--ch-ease-standard);
      }

      .brand__link:hover {
        opacity: 0.8;
      }

      .brand__text {
        display: flex;
        flex-direction: column;
        gap: var(--ch-space-xs);
      }

      .brand__title {
        font-size: var(--ch-text-lg);
        font-weight: var(--ch-weight-semibold);
        color: var(--ch-text-primary);
      }

      .brand__subtitle {
        margin: 0;
        color: var(--ch-text-secondary);
        font-size: var(--ch-text-sm);
        line-height: 1.4;
      }

      .nav-sections {
        display: grid;
        gap: var(--ch-space-2xl);
      }

      .nav-section {
        display: grid;
        gap: var(--ch-space-xs);
      }

      .nav-section__title {
        margin: 0;
        font-size: var(--ch-text-xs);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--ch-text-tertiary);
      }

      .nav-list {
        display: grid;
        gap: var(--ch-space-xs);
      }

      .nav-link {
        display: inline-flex;
        align-items: center;
        gap: var(--ch-space-xs);
        padding: var(--ch-space-sm) var(--ch-space-md);
        border-radius: var(--ch-radius-sm);
        text-decoration: none;
        font-size: var(--ch-text-sm);
        font-weight: var(--ch-weight-medium);
        color: var(--ch-text-secondary);
        transition: all var(--ch-dur-fast) var(--ch-ease-standard);
        position: relative;
      }

      .nav-link:hover {
        color: var(--ch-text-primary);
        background: var(--ch-hover-on-base);
      }

      .nav-link[aria-current="page"] {
        color: var(--ch-text-primary);
        background: var(--ch-active-on-base);
        font-weight: var(--ch-weight-semibold);
      }

      .nav-link--disabled {
        color: var(--ch-text-tertiary);
        cursor: not-allowed;
        border-color: transparent;
        background: transparent;
      }

      .nav-link--disabled:hover {
        color: var(--ch-text-tertiary);
        border-color: transparent;
        background: transparent;
      }

      .sidebar-controls {
        display: grid;
        gap: var(--ch-space-xs);
      }

      .control-label {
        font-size: var(--ch-text-xs);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--ch-text-tertiary);
      }

      #theme-select {
        width: 100%;
        font: inherit;
        font-size: var(--ch-text-sm);
        padding: var(--ch-space-sm) calc(var(--ch-space-xl) + var(--ch-space-sm))
          var(--ch-space-sm) var(--ch-space-md);
        border: var(--ch-border-width-sm) solid var(--ch-border-default);
        border-radius: var(--ch-radius-sm);
        background: transparent;
        color: var(--ch-text-primary);
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%23666' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--ch-space-sm) center;
      }

      #theme-select:focus-visible {
        outline: var(--ch-focus-outline-width) solid var(--ch-focus-outer);
        outline-offset: var(--ch-focus-outline-offset);
      }

      .control-button {
        font: inherit;
        font-size: var(--ch-text-sm);
        font-weight: var(--ch-weight-medium);
        padding: var(--ch-space-sm) var(--ch-space-md);
        border-radius: var(--ch-radius-sm);
        border: var(--ch-border-width-sm) solid var(--ch-border-default);
        background: transparent;
        color: var(--ch-text-secondary);
        cursor: pointer;
        transition: all var(--ch-dur-medium) var(--ch-ease-standard);
      }

      .control-button:hover {
        color: var(--ch-text-primary);
        border-color: var(--ch-border-default);
        background: var(--ch-hover-on-raised);
      }

      .control-button[aria-pressed="true"] {
        color: var(--ch-text-primary);
        border-color: var(--ch-action-primary-soft-border);
        background: var(--ch-action-primary-soft-bg);
        font-weight: var(--ch-weight-semibold);
      }

      .sidebar-footer {
        margin-top: auto;
        display: grid;
        gap: var(--ch-space-xs);
        font-size: var(--ch-text-xs);
      }

      .sidebar-footer a {
        color: var(--ch-text-secondary);
        text-decoration: none;
      }

      .sidebar-footer a:hover {
        color: var(--ch-text-primary);
      }

      @media (max-width: 960px) {
        .docs-sidebar {
          gap: var(--ch-space-lg);
        }
      }
    </style>
    <script type="module" src={initButtonsSrc}></script>
  </body>
</html>
