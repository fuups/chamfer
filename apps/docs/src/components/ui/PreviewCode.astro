---
interface Source {
  label: string;
  language: string;
  code: string;
}

const {
  label,
  sources,
  copyLabel = "Copy"
} = Astro.props as {
  label: string;
  sources: Source[];
  copyLabel?: string;
};

if (!Array.isArray(sources) || sources.length === 0) {
  throw new Error(`PreviewCode "${label}" requires at least one source entry.`);
}

const previewHtml = await Astro.slots.render("preview");
const hasPreview = previewHtml.trim().length > 0;
const initialTab = hasPreview ? "preview" : `code-0`;
const id = `preview-code-${Math.random().toString(36).slice(2, 10)}`;
---

<div class="preview-code" data-active={initialTab} id={id}>
  <div class="preview-code__header">
    <span class="preview-code__label">{label}</span>
    <div class="preview-code__tabs" role="tablist">
      {hasPreview && (
        <button
          type="button"
          class="preview-code__tab"
          data-tab="preview"
          role="tab"
          aria-selected="true"
        >
          Preview
        </button>
      )}
      {sources.map((source, index) => {
        const tabId = `code-${index}`;
        const selected = !hasPreview && index === 0 ? "true" : "false";
        return (
          <button
            type="button"
            class="preview-code__tab"
            data-tab={tabId}
            role="tab"
            aria-selected={selected}
          >
            {source.label}
          </button>
        );
      })}
    </div>
  </div>

  {hasPreview && (
    <div class="preview-code__panel" data-panel="preview" role="tabpanel">
      <div class="preview-code__preview" set:html={previewHtml} />
    </div>
  )}

  {sources.map((source, index) => {
    const panelId = `code-${index}`;
    return (
      <div class="preview-code__panel" data-panel={panelId} role="tabpanel">
        <div class="preview-code__panel-toolbar">
          <span class="preview-code__panel-title">{source.label}</span>
          <div class="preview-code__actions">
            <button
              type="button"
              class="preview-code__copy"
              data-copy={index}
              aria-label={`${copyLabel} ${source.label}`}
            >
              {copyLabel}
            </button>
          </div>
        </div>
        <pre class="preview-code__pre">
          <code class={`language-${source.language}`} data-code={index}>
{source.code}
          </code>
        </pre>
      </div>
    );
  })}
</div>

<style>
  .preview-code {
    border: 1px solid var(--ch-border-default, rgba(0, 0, 0, 0.12));
    border-radius: var(--ch-radius-md, 0.75rem);
    background: var(--ch-surface-raised);
    display: flex;
    flex-direction: column;
    margin-bottom: var(--ch-space-lg, 1.5rem);
  }

  .preview-code__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--ch-space-sm, 0.75rem);
    padding: var(--ch-space-sm, 0.75rem) var(--ch-space-md, 1rem);
    border-bottom: 1px solid var(--ch-border-default, rgba(0, 0, 0, 0.12));
  }

  .preview-code__label {
    font-size: var(--ch-text-sm, 0.875rem);
    font-weight: var(--ch-weight-medium, 500);
    color: var(--ch-text-secondary, rgba(90, 97, 105, 0.88));
  }

  .preview-code__tabs {
    display: inline-flex;
    align-items: center;
    gap: var(--ch-space-xs, 0.35rem);
  }

  .preview-code__tab {
    font: inherit;
    font-size: var(--ch-text-xs, 0.78rem);
    font-weight: var(--ch-weight-medium, 500);
    padding: var(--ch-space-xs, 0.35rem) var(--ch-space-sm, 0.65rem);
    border-radius: var(--ch-radius-pill, 999px);
    border: 1px solid transparent;
    background: transparent;
    color: var(--ch-text-tertiary, rgba(90, 97, 105, 0.68));
    cursor: pointer;
    transition: all 150ms ease;
  }

  .preview-code__tab[aria-selected="true"] {
    background: var(--ch-action-primary-soft-bg, rgba(0, 0, 0, 0.06));
    color: var(--ch-text-primary, #212529);
    border-color: var(--ch-action-primary-soft-border, rgba(0, 0, 0, 0.24));
  }

  .preview-code__panel {
    display: none;
    padding: var(--ch-space-md, 1rem);
    gap: var(--ch-space-sm);
    flex-direction: column;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .preview-code__panel.is-active {
    display: flex;
  }

  .preview-code__preview {
    width: 100%;
  }

  .preview-code__panel-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--ch-space-sm, 0.75rem);
  }

  .preview-code__panel-title {
    font-size: var(--ch-text-xs, 0.78rem);
    font-weight: var(--ch-weight-semibold, 600);
    color: var(--ch-text-secondary, rgba(90, 97, 105, 0.78));
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  .preview-code__actions {
    display: inline-flex;
    align-items: center;
    gap: var(--ch-space-xs, 0.5rem);
  }

  .preview-code__copy {
    font: inherit;
    font-size: var(--ch-text-xs, 0.75rem);
    padding: var(--ch-space-xs, 0.35rem) var(--ch-space-sm, 0.65rem);
    border-radius: var(--ch-radius-pill, 999px);
    border: 1px solid var(--ch-border-default, rgba(0, 0, 0, 0.12));
    background: transparent;
    color: var(--ch-text-secondary, rgba(90, 97, 105, 0.88));
    cursor: pointer;
    transition: background 150ms ease;
  }

  .preview-code__copy:hover {
    background: var(--ch-action-primary-soft-bg, rgba(0, 0, 0, 0.06));
  }

  .preview-code__pre {
    margin: 0;
    padding: 0;
    border: 0;
    background: var(--ch-surface-raised, #0f172a);
    color: #f8fafc;
    overflow-x: auto;
    width: max-content;
    min-width: 100%;
    white-space: pre;
  }

  @media (max-width: 768px) {
    .preview-code__pre {
      width: 100%;
      white-space: pre-wrap;
      word-break: break-word;
    }
  }

  .preview-code[data-wrap="true"] {
    white-space: pre-wrap;
    word-break: break-word;
  }
</style>

<script is:inline data-target={id} data-copy-label={copyLabel}>
  (() => {
    const script = document.currentScript;
    if (!script) return;

    const targetId = script.dataset.target || "";
    const defaultCopyLabel = script.dataset.copyLabel || "Copy";
    const container = targetId
      ? document.getElementById(targetId)
      : script.previousElementSibling;
    if (!container) return;

    const tabs = Array.from(
      container.querySelectorAll(".preview-code__tab")
    );
    const panels = Array.from(
      container.querySelectorAll(".preview-code__panel")
    );

    const setActive = panelId => {
      container.setAttribute("data-active", panelId);
      tabs.forEach(tab => {
        const tabId = tab.dataset.tab;
        tab.setAttribute("aria-selected", tabId === panelId ? "true" : "false");
      });
      panels.forEach(panel => {
        panel.classList.toggle(
          "is-active",
          panel.dataset.panel === panelId
        );
      });
    };

    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        const tabId = tab.dataset.tab;
        if (!tabId) return;
        setActive(tabId);
      });
    });

    const copyButtons = Array.from(
      container.querySelectorAll(".preview-code__copy")
    );

    copyButtons.forEach(button => {
      button.addEventListener("click", async () => {
        const index = button.dataset.copy;
        if (typeof index === "undefined") {
          return;
        }
        const codeEl = container.querySelector(
          `code[data-code="${index}"]`
        );
        if (!codeEl) return;

        const text = codeEl.innerText.trim();
        try {
          await navigator.clipboard.writeText(text);
          button.textContent = "Copied";
          setTimeout(() => {
            button.textContent = defaultCopyLabel;
          }, 1500);
        } catch (error) {
          console.error(error);
          button.textContent = "Error";
          setTimeout(() => {
            button.textContent = defaultCopyLabel;
          }, 1500);
        }
      });
    });

    const initial = container.dataset.active || (tabs[0] ? tabs[0].dataset.tab : "");
    if (initial) {
      setActive(initial);
    }
  })();
</script>
